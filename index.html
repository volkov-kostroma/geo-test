<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –±–µ–∑ GPS + –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞</title>

<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>

<style>
    #map {
        width: 600px;
        height: 400px;
        margin-top: 20px;
        border: 1px solid #ccc;
    }
</style>
</head>

<body>

<h2>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –±–µ–∑ GPS (—Ç–æ–ª—å–∫–æ Wi-Fi / IP)</h2>
<button onclick="getLocation()">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>

<pre id="output"></pre>
<div id="map"></div>

<script>
let map;

// --- FALLBACK –ü–û IP ---
function fallbackByIp(out) {
    out.textContent += "\n\n–ü—Ä–æ–±—É—é –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ IP...";

    fetch("https://ipapi.co/json/")
        .then(r => r.json())
        .then(data => {
            const lat = data.latitude;
            const lon = data.longitude;

            out.innerHTML +=
                `\n\nüåç –ü–æ IP:\n` +
                `–®–∏—Ä–æ—Ç–∞:  ${lat}\n` +
                `–î–æ–ª–≥–æ—Ç–∞: ${lon}\n`;

            ymaps.ready(() => initMap(lat, lon));
        })
        .catch(() => {
            out.textContent += "\n–û—à–∏–±–∫–∞ IP-–≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.";
        });
}

// --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ ---
function initMap(lat, lon) {
    if (!map) {
        map = new ymaps.Map("map", {
            center: [lat, lon],
            zoom: 17
        });
    } else {
        map.setCenter([lat, lon], 17);
        map.geoObjects.removeAll();
    }

    const placemark = new ymaps.Placemark([lat, lon], {
        balloonContent: "–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–±–µ–∑ GPS)"
    });

    map.geoObjects.add(placemark);
}

// --- –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
function getLocation() {
    const out = document.getElementById("output");

    if (!navigator.geolocation) {
        out.textContent = "‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.";
        return;
    }

    out.textContent = "‚è≥ –û–ø—Ä–µ–¥–µ–ª—è—é (Wi-Fi / IP, –±–µ–∑ GPS)...";

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            // === –û–¢–õ–û–í GPS ===
            if (pos.coords.altitude !== null ||
                pos.coords.speed !== null ||
                pos.coords.heading !== null) {

                out.textContent = "‚õî –û–±–Ω–∞—Ä—É–∂–µ–Ω GPS! –ò–≥–Ω–æ—Ä–∏—Ä—É—é. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Wi-Fi/IP.";
                return fallbackByIp(out);
            }

            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const acc = pos.coords.accuracy;

            out.textContent =
                `‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –±–µ–∑ GPS\n\n` +
                `–®–∏—Ä–æ—Ç–∞:  ${lat}\n` +
                `–î–æ–ª–≥–æ—Ç–∞: ${lon}\n` +
                `–¢–æ—á–Ω–æ—Å—Ç—å: ${acc} –º`;

            ymaps.ready(() => initMap(lat, lon));
        },

        (error) => {
            out.textContent = "‚ùå –û—à–∏–±–∫–∞: " + error.message;
            fallbackByIp(out);
        },

        {
            enableHighAccuracy: false,   // –∫–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä ‚Äî GPS OFF
            timeout: 2000,               // GPS –Ω–µ —É—Å–ø–µ–µ—Ç –≤–∫–ª—é—á–∏—Ç—å—Å—è
            maximumAge: 0
        }
    );
}
</script>

</body>
</html>
